import{r as g,b as z,j as t}from"./vendor-BjgPdEnQ.js";import{s as m}from"./game-DMqPqpoE.js";import{a as W,b as Q,c as V,g as X,h as Y,k as Z,d as ee,s as ae,e as re,f as se,i as ne,p as te}from"./guru-D7H-5Pkh.js";const y=[{id_siswa:1,nis:"2023001",nama:"Rudi Hartono",id_kelas:1,tanggal_lahir:"2012-03-14",alamat:"Jl. Cemara No.8",id_role:4},{id_siswa:2,nis:"2023002",nama:"Nisa Kurnia",id_kelas:2,tanggal_lahir:"2012-06-21",alamat:"Jl. Melati No.9",id_role:4},{id_siswa:3,nis:"123131",nama:"Fachri Aditya Rizky",id_kelas:1,alamat:"sdfscds",id_role:4}],C={admin:[{username:"budi.setiawan",password:"admin123",type:"superadmin",nama:"Budi Setiawan"},{username:"siti.aminah",password:"pass1234",type:"admin_sekolah",nama:"Siti Aminah"},{username:"dodi.pratama",password:"pass1234",type:"admin_dev",nama:"Dodi Pratama"}],guru:{username:"guru",password:"guru123",nama:"Ahmad Fauzi",nuptk:"198401232005011001",id_guru:1,no_telp:"081234567890",alamat:"Jl. Pendidikan No.1",id_role:2,kelas:[1,2,3]},ortu:{username:"ortu",password:"ortu123"}},$=[{id_guru:1,nuptk:"198401232005011001",nama:"Ahmad Fauzi",no_telp:"081234567890",alamat:"Jl. Pendidikan No.1",id_role:2,kelas:[1,2,3]},{id_guru:2,nuptk:"197905152003021002",nama:"Lilis Kusuma",no_telp:"082134567891",alamat:"Jl. Merdeka No.2",id_role:2,kelas:[4,5,6]}],I=(s,i,e)=>{let n;switch(e){case"siswa":n=y.find(c=>c.nama===s&&c.nis===i);break;case"guru":n=$.find(c=>c.nama===s&&c.nuptk===i);break}if(!n)throw new Error("Invalid credentials");return{user:n,session:null,isOffline:!0}},oe=async(s,i)=>{try{if(console.log(`[Database] Mencoba login siswa dengan nama: ${s} dan NIS: ${i}`),!m){console.error("[Database] Supabase client tidak tersedia");const e=y.find(n=>n.nama===s&&n.nis===i);if(!e)throw new Error("Siswa tidak ditemukan (offline mode)");return console.log("[Database] Menggunakan data offline:",e),e}if(typeof m.from!="function")if(console.error("[Database] Metode from tidak tersedia pada supabase client"),m.from&&typeof m.from=="function"){console.log("[Database] Mencoba memperbaiki metode from dengan cara alternatif");try{const e=m.from.bind(m),n=e("siswa");if(n&&typeof n.select=="function")console.log("[Database] Metode from berhasil diperbaiki"),m.from=e;else{console.error("[Database] Metode from tidak dapat diperbaiki");const c=y.find(u=>u.nama===s&&u.nis===i);if(!c)throw new Error("Siswa tidak ditemukan (offline mode)");return console.log("[Database] Menggunakan data offline:",c),c}}catch(e){console.error("[Database] Error saat memperbaiki metode from:",e);const n=y.find(c=>c.nama===s&&c.nis===i);if(!n)throw new Error("Siswa tidak ditemukan (offline mode)");return console.log("[Database] Menggunakan data offline:",n),n}}else{const e=y.find(n=>n.nama===s&&n.nis===i);if(!e)throw new Error("Siswa tidak ditemukan (offline mode)");return console.log("[Database] Menggunakan data offline:",e),e}try{console.log("[Database] Mencoba dengan metode Supabase client");const{data:e,error:n}=await m.from("siswa").select(`
          *,
          kelas (
            id_kelas,
            nama_kelas
          )
        `).eq("nama",s).eq("nis",i);if(console.log("[Database] Hasil query Supabase:",{data:e,error:n}),n)throw console.error("[Database] Error dengan metode Supabase client:",n),n;if(!e||e.length===0)throw console.warn("[Database] Tidak ada data siswa yang ditemukan"),new Error("Siswa tidak ditemukan");return console.log("[Database] Login siswa berhasil dengan data:",e[0]),e[0]}catch(e){console.error("[Database] Error dengan Supabase client, mencoba dengan fetch API:",e);try{const c=`${m.supabaseUrl}/rest/v1/siswa?select=*,kelas(id_kelas,nama_kelas)&nama=eq.${encodeURIComponent(s)}&nis=eq.${encodeURIComponent(i)}`;console.log("[Database] Request URL:",c);const u=await fetch(c,{method:"GET",headers:{apikey:m.supabaseKey,Authorization:`Bearer ${m.supabaseKey}`,"Content-Type":"application/json",Accept:"application/json",Prefer:"return=representation"}});if(!u.ok)throw console.error("[Database] HTTP error:",u.status,u.statusText),new Error(`HTTP error! status: ${u.status}`);const h=await u.json();if(console.log("[Database] Data dari fetch API:",h),!h||h.length===0)throw console.warn("[Database] Tidak ada data siswa yang ditemukan dengan fetch API"),new Error("Siswa tidak ditemukan");return console.log("[Database] Login siswa berhasil dengan fetch API:",h[0]),h[0]}catch(n){console.error("[Database] Fetch API error:",n);const c=y.find(u=>u.nama===s&&u.nis===i);if(!c)throw new Error("Siswa tidak ditemukan (offline mode)");return console.log("[Database] Menggunakan data offline sebagai fallback terakhir:",c),c}}}catch(e){throw console.error("[Database] Login siswa error:",e),e}},ie=async(s,i)=>{try{if(console.log(`[Database] Mencoba login guru dengan nama: ${s} dan NUPTK: ${i}`),!m)return console.error("[Database] Supabase client tidak tersedia"),I(s,i,"guru");try{console.log("[Database] Mencoba dengan metode Supabase client");const{data:e,error:n}=await m.from("guru").select("*").eq("nama",s).eq("nuptk",i).single();if(n)throw console.error("[Database] Error dengan metode Supabase client:",n),n;return e?(console.log("[Database] Login guru berhasil dengan data:",e),{...e,isLoggedIn:!0,role:"guru",lastLoginTime:new Date().toISOString(),offline:!1}):(console.warn("[Database] Tidak ada data guru yang ditemukan"),I(s,i,"guru"))}catch(e){return console.error("[Database] Login guru error:",e),I(s,i,"guru")}}catch(e){throw console.error("[Database] Login guru error:",e),e}},le=async(s,i)=>{try{if(console.log(`[Database] Attempting admin login with username: ${s}`),!m)return console.error("[Database] Supabase client not available"),I(s,i,"admin");try{const{data:e,error:n}=await m.from("admin").select("*").eq("nama",s).single();if(n)throw n.code==="42P17"?(console.error("[Database] Supabase RLS policy error (infinite recursion):",n),new Error("Supabase RLS policy error pada tabel 'admin': infinite recursion. Silakan perbaiki policy di dashboard Supabase.")):(console.error("[Database] Error fetching admin:",n),new Error("Invalid credentials"));if(!e)throw console.warn("[Database] No admin found with provided name"),new Error("Invalid credentials");if(e.password!==i)throw console.warn("[Database] Invalid password"),new Error("Invalid credentials");return console.log("[Database] Admin login successful"),{...e,offline:!1}}catch(e){if(e&&e.message&&e.message.includes("infinite recursion"))throw e;return console.error("[Database] Admin login failed:",e),I(s,i,"admin")}}catch(e){throw e&&e.message&&e.message.includes("infinite recursion")||console.error("[Database] Admin login error:",e),e}},ce=[{name:"Anjing",src:W},{name:"Babi",src:Q},{name:"Bebek",src:V},{name:"Gurita",src:X},{name:"Harimau",src:Y},{name:"Kelinci",src:Z},{name:"Kucing",src:ee},{name:"Sapi",src:ae},{name:"Serigala",src:re},{name:"Singa",src:se},{name:"Laki-laki",src:ne},{name:"Perempuan",src:te}],ue=({message:s,type:i,onClose:e})=>(g.useEffect(()=>{const n=setTimeout(()=>{e()},4e3);return()=>clearTimeout(n)},[e]),t.jsx("div",{className:`notification ${i}`,onClick:e,children:s})),de=({message:s="Memproses login..."})=>t.jsxs("div",{className:"loading-spinner",children:[t.jsx("div",{className:"spinner"}),t.jsx("div",{className:"loading-text",children:s})]}),me=()=>t.jsx("div",{className:"avatar-skeleton-grid",children:Array(10).fill().map((s,i)=>t.jsx("div",{className:"avatar-skeleton"},i))});function be(){const[s,i]=g.useState(""),[e,n]=g.useState(""),[c,u]=g.useState(""),[h,b]=g.useState(!1),[E,R]=g.useState(!1),[x,U]=g.useState(null),[o,J]=g.useState(""),[D,d]=g.useState(!1),[_,v]=g.useState(!0),[M,K]=g.useState(0),[j,O]=g.useState(null),[S,q]=g.useState({}),[F,ge]=g.useState(!1),w=z(),p=(a,r="info")=>{O({message:a,type:r})},N=(a,r)=>{const l={...S};a==="username"&&!r.trim()?l.username="Nama tidak boleh kosong":a==="username"&&delete l.username,a==="password"&&!r.trim()?l.password=o==="siswa"?"NIS tidak boleh kosong":o==="guru"?"NUPTK tidak boleh kosong":"Password tidak boleh kosong":a==="password"&&delete l.password,q(l)};g.useEffect(()=>{const a=localStorage.getItem("selectedRole");a?J(a):w("/"),A()},[w]),g.useEffect(()=>{const a=()=>{navigator.onLine?D&&M<3&&A():(d(!0),v(!1))};return window.addEventListener("online",a),window.addEventListener("offline",()=>{d(!0),v(!1)}),a(),()=>{window.removeEventListener("online",a),window.removeEventListener("offline",()=>{d(!0),v(!1)})}},[D,M]);const A=async()=>{try{if(v(!0),!navigator.onLine)return console.log("Browser reports offline"),d(!0),!1;if(!m)return console.error("Supabase client not initialized"),d(!0),!1;try{const{error:a}=await m.from("siswa").select("id_siswa").limit(1);return a?(console.error("Database connection error:",a),d(!0),!1):(d(!1),!0)}catch(a){return console.error("Database test failed:",a),d(!0),!1}}catch(a){return console.error("Connection check error:",a),d(!0),!1}finally{v(!1)}},G=()=>{K(a=>a+1),A()},B=async a=>{a.preventDefault(),b(!0),u("");try{if(o==="siswa")try{const r=await oe(s,e);if(!r){p("Login gagal! Periksa kembali nama dan NIS Anda.","error"),b(!1);return}localStorage.setItem("userData",JSON.stringify(r)),r.offline&&(d(!0),localStorage.setItem("isOfflineMode","true")),p("Login siswa berhasil!","success"),setTimeout(()=>k(null,"siswa"),1500)}catch(r){console.error("Error during siswa login:",r),p("Login Gagal. Mencoba mode offline...","warning"),T()}else if(o==="guru")try{const r=await ie(s,e);if(!r){p("Login gagal! Periksa kembali nama dan NUPTK Anda.","error"),b(!1);return}localStorage.setItem("userData",JSON.stringify(r)),r.offline&&(d(!0),localStorage.setItem("isOfflineMode","true")),p("Login guru berhasil!","success"),setTimeout(()=>k(null,"guru"),1500)}catch(r){console.error("Error during guru login:",r);const l=C.guru;if(s===l.username&&e===l.password){const f={...l,offline:!0,isLoggedIn:!0,role:"guru",lastLoginTime:new Date().toISOString()};localStorage.setItem("userData",JSON.stringify(f)),localStorage.setItem("isOfflineMode","true"),d(!0),k(null,"guru")}else u("Username atau password guru salah!")}else if(o==="admin")try{console.log("Attempting admin login with username:",s);const r=await le(s,e);if(!r){u("Username atau password admin salah!"),p("Login gagal! Periksa kembali username dan password.","error"),b(!1);return}console.log("Admin login successful with user:",r);const l={nama:r.nama,tipe_admin:r.tipe_admin,id_admin:r.id_admin,username:s};localStorage.setItem("userData",JSON.stringify(l)),r.offline&&(d(!0),localStorage.setItem("isOfflineMode","true")),p("Login admin berhasil!","success"),setTimeout(()=>k(null,"admin"),1500)}catch(r){console.error("Error during admin login:",r),p("Login Gagal. Periksa Kembali Akun Anda....","error"),T()}}catch(r){console.error("Login error:",r),u(r.message||"Terjadi kesalahan saat login")}finally{b(!1)}},T=()=>{if(o==="siswa"){const a=dummySiswa.find(l=>l.nama===s&&l.nis===e);if(!a){u("Nama atau NIS tidak ditemukan dalam data offline"),b(!1);return}const r={...a,id_siswa:Date.now(),offline:!0,isLoggedIn:!0,role:"siswa",lastLoginTime:new Date().toISOString()};localStorage.setItem("userData",JSON.stringify(r)),localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userRole","siswa"),localStorage.setItem("id_siswa",r.id_siswa.toString()),localStorage.setItem("isOfflineMode","true"),d(!0),R(!0)}else if(o==="guru"){const a=$.find(l=>l.nama===s&&l.nuptk===e);if(!a){b(!1);return}const r={...a,offline:!0};localStorage.setItem("userData",JSON.stringify(r)),localStorage.setItem("isOfflineMode","true"),d(!0),k(null,"guru")}else if(o==="admin"){const a=C.admin.find(r=>r.username===s&&r.password===e);if(a){const r={nama:a.nama,tipe_admin:a.type,username:a.username,offline:!0};localStorage.setItem("userData",JSON.stringify(r)),localStorage.setItem("isOfflineMode","true"),d(!0),k(null,"admin")}else u("Username atau password admin salah!"),b(!1)}},P=async a=>{U(a),p(`Avatar ${a.name} dipilih!`,"success");try{const r=JSON.parse(localStorage.getItem("userData")||"{}");if(r&&r.id_siswa){let l=!0;if(!D)try{const f=await updateSiswaAvatar(r.id_siswa,a.name);f&&!f.error&&(f.offline&&(d(!0),localStorage.setItem("isOfflineMode","true")),r.avatar=f.avatar||a.name,l=!1)}catch(f){console.error("Error updating avatar online:",f)}l&&(r.avatar=a.name),localStorage.setItem("userData",JSON.stringify(r))}setTimeout(()=>k(a,"siswa"),1e3)}catch(r){console.error("Error during avatar selection:",r),k(a,"siswa")}},k=(a,r)=>{switch(localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userRole",r),localStorage.setItem("isOfflineMode",D.toString()),a&&localStorage.setItem("selectedAvatar",JSON.stringify(a)),r){case"siswa":{const f=JSON.parse(localStorage.getItem("userData")||"{}").id_kelas;w(f===1?"/kelas1":f===2?"/kelas2":f===3?"/kelas3":f===4?"/kelas4":f===5?"/kelas5":f===6?"/kelas6":"/main-siswa");break}case"guru":{w("/guru/dashboard");break}case"ortu":{w("/dashboard-ortu");break}case"admin":{w("/admin/dashboard");break}default:w("/")}},H=()=>{localStorage.removeItem("selectedRole"),w("/")},L=(()=>{switch(o){case"siswa":return{title:"Login Siswa",icon:null};case"guru":return{title:"Login Guru",icon:null};case"ortu":return{title:"Login Orang Tua",icon:null};case"admin":return{title:"Login Admin",icon:null};default:return{title:"Login",icon:null}}})();return t.jsxs("div",{className:"login-container",children:[j&&t.jsx(ue,{message:j.message,type:j.type,onClose:()=>O(null)}),D&&t.jsxs("div",{className:"offline-indicator",children:["Mode Offline - Data login digunakan dari local storage",t.jsx("button",{className:"retry-button",onClick:G,disabled:_,children:_?"Memeriksa...":"Coba Sambung Ulang"})]}),t.jsx("button",{className:`back-button role-${o}`,onClick:H,children:"Kembali"}),t.jsxs("div",{className:`login-box role-${o}`,children:[t.jsx("div",{className:"login-header",children:t.jsx("h2",{children:L.title})}),h&&t.jsx(de,{}),!E&&!h?t.jsxs("div",{className:"login-form1",children:[L.icon&&t.jsx("div",{className:"role-icon-container",children:t.jsx("img",{src:L.icon,alt:`Icon ${L.title}`,className:"role-icon-large"})}),t.jsxs("form",{onSubmit:B,children:[t.jsxs("div",{className:`input-group ${S.username?"error":s.trim()?"success":""}`,children:[t.jsx("label",{htmlFor:"username",children:o==="siswa"||o==="guru"?"Nama":o==="admin"?"Email":"Username"}),t.jsx("input",{type:"text",id:"username",value:s,onChange:a=>{i(a.target.value),N("username",a.target.value)},onBlur:a=>N("username",a.target.value),required:!0,autoComplete:o==="siswa"?"given-name":o==="guru"?"name":o==="admin"?"email":"username",placeholder:o==="siswa"||o==="guru"?"Masukkan nama":o==="ortu"?"ortu":"Masukkan email admin"}),S.username&&t.jsx("div",{className:"field-error",children:S.username})]}),t.jsxs("div",{className:`input-group ${S.password?"error":e.trim()?"success":""}`,children:[t.jsx("label",{htmlFor:"password",children:o==="siswa"?"Nomor Induk Siswa (NIS)":o==="guru"?"NUPTK":"Password"}),t.jsx("input",{type:o==="siswa"||o==="guru"?"text":"password",id:"password",value:e,onChange:a=>{n(a.target.value),N("password",a.target.value)},onBlur:a=>N("password",a.target.value),required:!0,autoComplete:o==="siswa"||o==="guru"?"username":"current-password",placeholder:o==="siswa"?"Masukkan NIS":o==="guru"?"Masukkan NUPTK":o==="ortu"?"ortu123":"Masukkan password"}),S.password&&t.jsx("div",{className:"field-error",children:S.password})]}),c&&t.jsx("div",{className:"error-message",children:c}),t.jsx("button",{type:"submit",className:"login-button",disabled:h,children:h?"Memproses...":"Login"})]})]}):E?t.jsxs("div",{className:"avatar-selection",children:[t.jsx("h3",{children:"Pilih Avatar Kamu!"}),F?t.jsx(me,{}):t.jsx("div",{className:"avatar-grid",children:ce.map((a,r)=>t.jsxs(motion.div,{className:"avatar-option",onClick:()=>P(a),onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),P(a))},tabIndex:0,role:"button","aria-label":`Pilih avatar ${a.name}`,"aria-selected":(x==null?void 0:x.name)===a.name,whileHover:{scale:1.05},whileTap:{scale:.95},initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:r*.05},children:[t.jsx("img",{src:a.src,alt:a.name}),t.jsx("p",{children:a.name})]},r))})]}):null]})]})}export{be as default};
