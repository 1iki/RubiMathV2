import{r as o,b as F,j as s}from"./vendor-BjgPdEnQ.js";import{a as H,b as q,c as W,g as z,h as Q,k as V,d as X,s as Y,e as Z,f as ee,i as ae,p as se}from"./guru-D7H-5Pkh.js";import{s as _}from"./game-DMqPqpoE.js";const re=[{name:"Anjing",src:H},{name:"Babi",src:q},{name:"Bebek",src:W},{name:"Gurita",src:z},{name:"Harimau",src:Q},{name:"Kelinci",src:V},{name:"Kucing",src:X},{name:"Sapi",src:Y},{name:"Serigala",src:Z},{name:"Singa",src:ee},{name:"Laki-laki",src:ae},{name:"Perempuan",src:se}],te=({message:n,type:w,onClose:l})=>(o.useEffect(()=>{const I=setTimeout(()=>{l()},4e3);return()=>clearTimeout(I)},[l]),s.jsx("div",{className:`notification ${w}`,onClick:l,children:n})),ne=({message:n="Memproses login..."})=>s.jsxs("div",{className:"loading-spinner",children:[s.jsx("div",{className:"spinner"}),s.jsx("div",{className:"loading-text",children:n})]}),ie=()=>s.jsx("div",{className:"avatar-skeleton-grid",children:Array(10).fill().map((n,w)=>s.jsx("div",{className:"avatar-skeleton"},w))});function de(){const[n,w]=o.useState(""),[l,I]=o.useState(""),[L,f]=o.useState(""),[p,m]=o.useState(!1),[A,D]=o.useState(!1),[x,K]=o.useState(null),[t,U]=o.useState(""),[h,c]=o.useState(!1),[O,S]=o.useState(!0),[M,R]=o.useState(0),[j,E]=o.useState(null),[g,T]=o.useState({}),[J,C]=o.useState(!1),u=F(),d=(e,r="info")=>{E({message:e,type:r})},b=(e,r)=>{const a={...g};e==="username"&&!r.trim()?a.username="Nama tidak boleh kosong":e==="username"&&delete a.username,e==="password"&&!r.trim()?a.password=t==="siswa"?"NIS tidak boleh kosong":t==="guru"?"NUPTK tidak boleh kosong":"Password tidak boleh kosong":e==="password"&&delete a.password,T(a)};o.useEffect(()=>{const e=localStorage.getItem("selectedRole");e?U(e):u("/"),y()},[u]),o.useEffect(()=>{const e=()=>{navigator.onLine?h&&M<3&&y():(c(!0),S(!1))};return window.addEventListener("online",e),window.addEventListener("offline",()=>{c(!0),S(!1)}),e(),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",()=>{c(!0),S(!1)})}},[h,M]);const y=async()=>{try{if(S(!0),!navigator.onLine)return console.log("Browser reports offline"),c(!0),!1;if(!_)return console.error("Supabase client not initialized"),c(!0),!1;try{const{error:e}=await _.from("siswa").select("id_siswa").limit(1);return e?(console.error("Database connection error:",e),c(!0),!1):(c(!1),!0)}catch(e){return console.error("Database test failed:",e),c(!0),!1}}catch(e){return console.error("Connection check error:",e),c(!0),!1}finally{S(!1)}},G=()=>{R(e=>e+1),y()},$=async e=>{e.preventDefault(),f(""),m(!0);const r={};if(n.trim()||(r.username="Nama tidak boleh kosong"),l.trim()||(r.password=t==="siswa"?"NIS tidak boleh kosong":t==="guru"?"NUPTK tidak boleh kosong":"Password tidak boleh kosong"),Object.keys(r).length>0){T(r),m(!1);return}if(!t){f("Error: Role tidak terdeteksi"),m(!1);return}try{if(t==="siswa")try{console.log("Mencoba login siswa dengan nama:",n,"dan NIS:",l);const a=await loginSiswa(n,l);if(!a){d("Login gagal! Periksa kembali nama dan NIS Anda.","error"),m(!1);return}if(!a.id_siswa){d("Data siswa tidak lengkap. Hubungi administrator.","error"),m(!1);return}const i={...a,isLoggedIn:!0,role:"siswa",lastLoginTime:new Date().toISOString()};localStorage.setItem("userData",JSON.stringify(i)),localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userRole","siswa"),localStorage.setItem("id_siswa",a.id_siswa.toString()),d("Login berhasil! Silakan pilih avatar Anda.","success"),C(!0),setTimeout(()=>{C(!1),D(!0)},1e3)}catch(a){console.error("Error during siswa login:",a),d("Login Gagal. Mencoba mode offline...","warning"),v()}else if(t==="guru")try{console.log("Mencoba login guru dengan nama:",n,"dan NUPTK:",l);const a=await loginGuru(n,l);if(!a){d("Login gagal! Periksa kembali nama dan NUPTK Anda.","error"),m(!1);return}console.log("Login guru berhasil dengan user:",a),localStorage.setItem("userData",JSON.stringify(a)),a.offline&&(c(!0),localStorage.setItem("isOfflineMode","true")),d("Login guru berhasil!","success"),setTimeout(()=>k(null,"guru"),1500)}catch(a){console.error("Error during guru login:",a),d("Login Gagal. Periksa Kembali Akun Anda....","error"),v()}else if(t==="admin")try{console.log("Attempting admin login with username:",n);const a=await loginAdmin(n,l);if(!a){f("Username atau password admin salah!"),d("Login gagal! Periksa kembali username dan password.","error"),m(!1);return}console.log("Admin login successful with user:",a);const i={nama:a.nama,tipe_admin:a.tipe_admin,id_admin:a.id_admin,username:n};localStorage.setItem("userData",JSON.stringify(i)),a.offline&&(c(!0),localStorage.setItem("isOfflineMode","true")),d("Login admin berhasil!","success"),setTimeout(()=>k(null,"admin"),1500)}catch(a){console.error("Error during admin login:",a),d("Login Gagal. Periksa Kembali Akun Anda....","error"),v()}}catch(a){console.error("Login error:",a),f("Terjadi kesalahan saat login. Silakan coba lagi atau gunakan mode offline."),d("Terjadi kesalahan saat login.","error"),m(!1),v()}},v=()=>{if(t==="siswa"){const e=dummySiswa.find(a=>a.nama===n&&a.nis===l);if(!e){f("Nama atau NIS tidak ditemukan dalam data offline"),m(!1);return}const r={...e,id_siswa:Date.now(),offline:!0,isLoggedIn:!0,role:"siswa",lastLoginTime:new Date().toISOString()};localStorage.setItem("userData",JSON.stringify(r)),localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userRole","siswa"),localStorage.setItem("id_siswa",r.id_siswa.toString()),localStorage.setItem("isOfflineMode","true"),c(!0),D(!0)}else if(t==="guru"){const e=dummyGuru.find(a=>a.nama===n&&a.nuptk===l);if(!e){m(!1);return}const r={...e,offline:!0};localStorage.setItem("userData",JSON.stringify(r)),localStorage.setItem("isOfflineMode","true"),c(!0),k(null,"guru")}else if(t==="admin"){const e=staticCredentials.admin.find(r=>r.username===n&&r.password===l);if(e){const r={nama:e.nama,tipe_admin:e.type,username:e.username,offline:!0};localStorage.setItem("userData",JSON.stringify(r)),localStorage.setItem("isOfflineMode","true"),c(!0),k(null,"admin")}else f("Username atau password admin salah!"),m(!1)}},P=async e=>{K(e),d(`Avatar ${e.name} dipilih!`,"success");try{const r=JSON.parse(localStorage.getItem("userData")||"{}");if(r&&r.id_siswa){let a=!0;if(!h)try{const i=await updateSiswaAvatar(r.id_siswa,e.name);i&&!i.error&&(i.offline&&(c(!0),localStorage.setItem("isOfflineMode","true")),r.avatar=i.avatar||e.name,a=!1)}catch(i){console.error("Error updating avatar online:",i)}a&&(r.avatar=e.name),localStorage.setItem("userData",JSON.stringify(r))}setTimeout(()=>k(e,"siswa"),1e3)}catch(r){console.error("Error during avatar selection:",r),k(e,"siswa")}},k=(e,r)=>{switch(localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userRole",r),localStorage.setItem("isOfflineMode",h.toString()),e&&localStorage.setItem("selectedAvatar",JSON.stringify(e)),r){case"siswa":{const i=JSON.parse(localStorage.getItem("userData")||"{}").id_kelas;u(i===1?"/kelas1":i===2?"/kelas2":i===3?"/kelas3":i===4?"/kelas4":i===5?"/kelas5":i===6?"/kelas6":"/main-siswa");break}case"guru":{u("/guru/dashboard");break}case"ortu":{u("/dashboard-ortu");break}case"admin":{u("/admin/dashboard");break}default:u("/")}},B=()=>{localStorage.removeItem("selectedRole"),u("/")},N=(()=>{switch(t){case"siswa":return{title:"Login Siswa",icon:null};case"guru":return{title:"Login Guru",icon:null};case"ortu":return{title:"Login Orang Tua",icon:null};case"admin":return{title:"Login Admin",icon:null};default:return{title:"Login",icon:null}}})();return s.jsxs("div",{className:"login-container",children:[j&&s.jsx(te,{message:j.message,type:j.type,onClose:()=>E(null)}),h&&s.jsxs("div",{className:"offline-indicator",children:["Mode Offline - Data login digunakan dari local storage",s.jsx("button",{className:"retry-button",onClick:G,disabled:O,children:O?"Memeriksa...":"Coba Sambung Ulang"})]}),s.jsx("button",{className:`back-button role-${t}`,onClick:B,children:"Kembali"}),s.jsxs("div",{className:`login-box role-${t}`,children:[s.jsx("div",{className:"login-header",children:s.jsx("h2",{children:N.title})}),p&&s.jsx(ne,{}),!A&&!p?s.jsxs("div",{className:"login-form1",children:[N.icon&&s.jsx("div",{className:"role-icon-container",children:s.jsx("img",{src:N.icon,alt:`Icon ${N.title}`,className:"role-icon-large"})}),s.jsxs("form",{onSubmit:$,children:[s.jsxs("div",{className:`input-group ${g.username?"error":n.trim()?"success":""}`,children:[s.jsx("label",{htmlFor:"username",children:t==="siswa"||t==="guru"?"Nama":t==="admin"?"Email":"Username"}),s.jsx("input",{type:"text",id:"username",value:n,onChange:e=>{w(e.target.value),b("username",e.target.value)},onBlur:e=>b("username",e.target.value),required:!0,autoComplete:t==="siswa"?"given-name":t==="guru"?"name":t==="admin"?"email":"username",placeholder:t==="siswa"||t==="guru"?"Masukkan nama":t==="ortu"?"ortu":"Masukkan email admin"}),g.username&&s.jsx("div",{className:"field-error",children:g.username})]}),s.jsxs("div",{className:`input-group ${g.password?"error":l.trim()?"success":""}`,children:[s.jsx("label",{htmlFor:"password",children:t==="siswa"?"Nomor Induk Siswa (NIS)":t==="guru"?"NUPTK":"Password"}),s.jsx("input",{type:t==="siswa"||t==="guru"?"text":"password",id:"password",value:l,onChange:e=>{I(e.target.value),b("password",e.target.value)},onBlur:e=>b("password",e.target.value),required:!0,autoComplete:t==="siswa"||t==="guru"?"username":"current-password",placeholder:t==="siswa"?"Masukkan NIS":t==="guru"?"Masukkan NUPTK":t==="ortu"?"ortu123":"Masukkan password"}),g.password&&s.jsx("div",{className:"field-error",children:g.password})]}),L&&s.jsx("div",{className:"error-message",children:L}),s.jsx("button",{type:"submit",className:"login-button",disabled:p,children:p?"Memproses...":"Login"})]})]}):A?s.jsxs("div",{className:"avatar-selection",children:[s.jsx("h3",{children:"Pilih Avatar Kamu!"}),J?s.jsx(ie,{}):s.jsx("div",{className:"avatar-grid",children:re.map((e,r)=>s.jsxs(motion.div,{className:"avatar-option",onClick:()=>P(e),onKeyDown:a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),P(e))},tabIndex:0,role:"button","aria-label":`Pilih avatar ${e.name}`,"aria-selected":(x==null?void 0:x.name)===e.name,whileHover:{scale:1.05},whileTap:{scale:.95},initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:r*.05},children:[s.jsx("img",{src:e.src,alt:e.name}),s.jsx("p",{children:e.name})]},r))})]}):null]})]})}export{de as default};
